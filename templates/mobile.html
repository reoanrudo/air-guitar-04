<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Air Guitar Pro - Mobile Controller</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <div class="flex-1 flex flex-col h-screen w-full bg-slate-950 overflow-hidden select-none touch-none font-sans">
        <!-- Status Bar -->
        <div class="flex items-center justify-between px-6 py-4 bg-slate-900 border-b border-white/5">
            <div class="flex items-center gap-3">
                <div id="statusDot" class="status-dot connecting"></div>
                <span id="statusText" class="text-xs font-black tracking-[0.2em] text-white uppercase opacity-70">
                    LINKING...
                </span>
            </div>
            <div class="text-right">
                <div class="text-[8px] font-bold text-slate-500 uppercase">Room Code</div>
                <div class="font-mono text-sm font-black text-orange-500 leading-none">{{ room_id }}</div>
            </div>
            <button id="exitBtn" class="ml-4 p-2 px-4 bg-white/5 rounded-xl text-[10px] font-bold border border-white/5">EXIT</button>
        </div>

        <!-- Fretboard Area -->
        <div class="flex-1 flex fret-board relative">
            <!-- String Names Rail -->
            <div class="w-14 flex flex-col justify-around py-4 bg-black/40 border-r border-white/10 z-20">
                <div class="text-center font-black text-slate-600 text-xs italic">E</div>
                <div class="text-center font-black text-slate-600 text-xs italic">A</div>
                <div class="text-center font-black text-slate-600 text-xs italic">D</div>
                <div class="text-center font-black text-slate-600 text-xs italic">G</div>
                <div class="text-center font-black text-slate-600 text-xs italic">B</div>
                <div class="text-center font-black text-slate-600 text-xs italic">E</div>
            </div>

            <!-- Frets Grid -->
            <div class="flex-1 flex relative bg-[#0f172a]" id="fretGrid">
                <!-- Fret Vertical Lines (Visual) -->
                <div class="fret-line" style="left: 25%"></div>
                <div class="fret-line" style="left: 50%"></div>
                <div class="fret-line" style="left: 75%"></div>
                <div class="fret-line" style="left: 100%"></div>

                <!-- Strings and Interaction Layers -->
                <div class="flex-1 flex flex-col py-4" id="stringsContainer"></div>
            </div>
        </div>

        <!-- Quick Chord Shortcuts -->
        <div class="h-28 bg-slate-900/80 border-t border-white/5 p-4 grid grid-cols-4 gap-3 backdrop-blur-xl" id="chordContainer">
            <button class="chord-button inactive" data-chord="C">C</button>
            <button class="chord-button inactive" data-chord="G">G</button>
            <button class="chord-button inactive" data-chord="D">D</button>
            <button class="chord-button inactive" data-chord="Am">Am</button>
        </div>

        <div class="bg-orange-600 h-1 w-full opacity-50"></div>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
    <script>
        const ROOM_ID = '{{ room_id }}';
        const TOTAL_FRETS = 4;
        const STRING_NAMES = ['E', 'A', 'D', 'G', 'B', 'E'];

        // Chord patterns [E, A, D, G, B, E]
        const CHORD_PATTERNS = {
            'C': [0, 1, 0, 2, 3, 0],
            'G': [3, 0, 0, 0, 2, 3],
            'D': [2, 3, 2, 0, 0, 0],
            'Am': [0, 1, 2, 2, 0, 0]
        };

        let fretStates = [0, 0, 0, 0, 0, 0];
        let peer = null;
        let conn = null;

        // Initialize strings
        function initStrings() {
            const container = document.getElementById('stringsContainer');
            container.innerHTML = '';

            STRING_NAMES.forEach((name, sIdx) => {
                const stringRow = document.createElement('div');
                stringRow.className = 'flex-1 flex relative items-center';

                // String visual
                const stringLine = document.createElement('div');
                stringLine.className = 'string-line inactive';
                stringLine.id = `string-${sIdx}`;
                stringRow.appendChild(stringLine);

                // Touch zones
                const touchContainer = document.createElement('div');
                touchContainer.className = 'flex w-full h-full relative z-20';

                // Open string zone
                const openZone = document.createElement('div');
                openZone.className = 'flex-1 flex items-center justify-center transition-all';
                openZone.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    handleTouch(sIdx, 0);
                });
                const openBtn = document.createElement('div');
                openBtn.className = 'fret-button open-inactive';
                openBtn.id = `open-btn-${sIdx}`;
                openBtn.textContent = 'O';
                openZone.appendChild(openBtn);
                touchContainer.appendChild(openZone);

                // Fret zones
                for (let fIdx = 0; fIdx < TOTAL_FRETS; fIdx++) {
                    const fretZone = document.createElement('div');
                    fretZone.className = 'flex-[2] flex items-center justify-center transition-all';
                    fretZone.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        handleTouch(sIdx, fIdx + 1);
                    });
                    const fretBtn = document.createElement('div');
                    fretBtn.className = 'fret-button inactive';
                    fretBtn.id = `fret-btn-${sIdx}-${fIdx}`;
                    fretBtn.textContent = fIdx + 1;
                    fretZone.appendChild(fretBtn);
                    touchContainer.appendChild(fretZone);
                }

                stringRow.appendChild(touchContainer);
                container.appendChild(stringRow);
            });
        }

        function handleTouch(stringIdx, fret) {
            // Vibrate if supported
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }

            fretStates[stringIdx] = fret;
            updateFretboard();
            sendFretUpdate();
        }

        function updateFretboard() {
            for (let sIdx = 0; sIdx < 6; sIdx++) {
                const fret = fretStates[sIdx];
                const stringLine = document.getElementById(`string-${sIdx}`);

                // Update string visual
                if (fret > 0) {
                    stringLine.className = 'string-line active';
                } else {
                    stringLine.className = 'string-line inactive';
                }

                // Update open button
                const openBtn = document.getElementById(`open-btn-${sIdx}`);
                if (fret === 0) {
                    openBtn.className = 'fret-button open-active';
                } else {
                    openBtn.className = 'fret-button open-inactive';
                }

                // Update fret buttons
                for (let fIdx = 0; fIdx < TOTAL_FRETS; fIdx++) {
                    const fretBtn = document.getElementById(`fret-btn-${sIdx}-${fIdx}`);
                    if (fret === fIdx + 1) {
                        fretBtn.className = 'fret-button active';
                    } else {
                        fretBtn.className = 'fret-button inactive';
                    }
                }
            }

            // Update chord buttons
            updateChordButtons();
        }

        function updateChordButtons() {
            const chordButtons = document.querySelectorAll('.chord-button');
            chordButtons.forEach(btn => {
                const chordName = btn.dataset.chord;
                const pattern = CHORD_PATTERNS[chordName];
                const isActive = pattern.every((v, i) => v === fretStates[i]);
                btn.className = isActive ? 'chord-button active' : 'chord-button inactive';
            });
        }

        function setChord(chordName) {
            if (navigator.vibrate) {
                navigator.vibrate([15, 10, 15]);
            }
            fretStates = [...CHORD_PATTERNS[chordName]];
            updateFretboard();
            sendFretUpdate();
        }

        function sendFretUpdate() {
            if (conn && conn.open) {
                conn.send({ type: 'FRET_UPDATE', payload: fretStates });
            }
        }

        // WebRTC setup
        function initWebRTC() {
            peer = new Peer(`AIR-GUITAR-MOBILE-${ROOM_ID}`, {
                debug: 1,
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });

            peer.on('open', (id) => {
                console.log('Mobile peer ID:', id);
                connectToHost();
            });

            peer.on('error', (err) => {
                console.error('PeerJS Error:', err.type, err.message);
                if (err.type === 'peer-unavailable') {
                    setTimeout(connectToHost, 3000);
                }
            });

            peer.on('disconnected', () => {
                console.warn('Disconnected, reconnecting...');
                peer.reconnect();
            });
        }

        function connectToHost() {
            if (!peer || peer.destroyed) return;

            const targetId = `AIR-GUITAR-PC-${ROOM_ID}`;
            console.log('Connecting to host:', targetId);

            conn = peer.connect(targetId, { reliable: true });

            conn.on('open', () => {
                console.log('Connected to PC');
                updateConnectionStatus(true);
            });

            conn.on('close', () => {
                console.log('Connection closed');
                updateConnectionStatus(false);
                setTimeout(connectToHost, 2000);
            });

            conn.on('error', (err) => {
                console.error('Connection error:', err);
            });
        }

        function updateConnectionStatus(connected) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');

            if (connected) {
                statusDot.className = 'status-dot connected';
                statusText.textContent = 'LINKED TO PC';
            } else {
                statusDot.className = 'status-dot connecting';
                statusText.textContent = 'LINKING...';
            }
        }

        // Exit button
        document.getElementById('exitBtn').addEventListener('click', () => {
            if (conn) conn.close();
            if (peer) peer.destroy();
            window.location.href = '/';
        });

        // Chord buttons
        document.querySelectorAll('.chord-button').forEach(btn => {
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                setChord(btn.dataset.chord);
            });
        });

        // Initialize
        initStrings();
        initWebRTC();
    </script>
</body>
</html>
